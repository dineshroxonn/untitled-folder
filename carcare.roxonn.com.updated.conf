# Configuration for carcare.roxonn.com
server {
    listen 80;
    server_name carcare.roxonn.com;
    
    # When behind ALB, trust X-Forwarded-Proto for SSL detection
    set $is_https "no";
    if ($http_x_forwarded_proto = "https") {
        set $is_https "yes";
    }
    
    # Only redirect to HTTPS if not already HTTPS via proxy
    if ($is_https != "yes") {
        return 301 https://$host$request_uri;
    }
    
    # If X-Forwarded-Proto is https, treat as SSL even on port 80
    # This handles the case where ALB has terminated SSL
    include /etc/nginx/mime.types;
    
    # Enable gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    
    # Trust X-Forwarded-* headers from ALB
    real_ip_header X-Forwarded-For;
    set_real_ip_from 0.0.0.0/0;
    
    # Proxy all requests to the car diagnostic GUI
    location / {
        proxy_pass http://localhost:9000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # Simplified cookie settings
        proxy_cookie_path / "/";
        proxy_cookie_domain ~\.?roxonn\.com$ .roxonn.com;
        proxy_cache_bypass $http_upgrade;
        
        # Increase timeouts for long operations
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }
    
    # Special handling for API endpoints
    location /api/ {
        proxy_pass http://localhost:9000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # Simplified cookie settings
        proxy_cookie_path / "/";
        proxy_cookie_domain ~\.?roxonn\.com$ .roxonn.com;
        proxy_cache_bypass $http_upgrade;
        
        # Increase timeouts for long operations
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }
}

# The HTTPS server block is not needed since ALB handles SSL termination
# But we'll keep it for direct access if needed
server {
    listen 443 ssl http2;
    server_name carcare.roxonn.com;
    
    # Use the existing wildcard certificate
    ssl_certificate /etc/letsencrypt/live/app.roxonn.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/app.roxonn.com/privkey.pem;
    
    # SSL configurations
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:10m;
    ssl_stapling on;
    ssl_stapling_verify on;
    
    # Default MIME types
    include /etc/nginx/mime.types;
    
    # Enable gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    
    # Trust X-Forwarded-* headers from ALB
    real_ip_header X-Forwarded-For;
    set_real_ip_from 0.0.0.0/0;
    
    # Proxy all requests to the car diagnostic GUI
    location / {
        proxy_pass http://localhost:9000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port 443;
        
        # Simplified cookie settings
        proxy_cookie_path / "/";
        proxy_cookie_domain ~\.?roxonn\.com$ .roxonn.com;
        proxy_cache_bypass $http_upgrade;
        
        # Increase timeouts for long operations
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }
    
    # Special handling for API endpoints
    location /api/ {
        proxy_pass http://localhost:9000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port 443;
        
        # Simplified cookie settings
        proxy_cookie_path / "/";
        proxy_cookie_domain ~\.?roxonn\.com$ .roxonn.com;
        proxy_cache_bypass $http_upgrade;
        
        # Increase timeouts for long operations
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }
}